{% extends 'healthbridge_app/base.html' %}
{% load static %}

{% block title %}Recipient Dashboard - HealthBridge{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'dashboard/recipient_dashboard.css' %}">
{% endblock %}

{% block content %}
<!-- Professional Recipient Dashboard -->
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="dashboard-title">Recipient Dashboard</h1>
            <p class="dashboard-subtitle">Welcome back, {{ user.first_name }}</p>
        </div>
        <div class="header-actions">
            <button class="btn-primary" onclick="openAllMedicinesModal()">
                Browse Medicines to Request
            </button>
            <button class="btn-secondary" onclick="openHistoryModal()">
                My Requests
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Total Requests</span>
            </div>
            <div class="stat-value">{{ total_requests }}</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Pending</span>
            </div>
            <div class="stat-value">{{ pending_requests }}</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Fulfilled</span>
            </div>
            <div class="stat-value">{{ fulfilled_requests }}</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Claimed</span>
            </div>
            <div class="stat-value">{{ claimed_count }}</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Recently Donated Medicines</span>
            </div>
            <div class="stat-value">{{ available_medicines_count }}</div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- My Requests Table -->
        <div class="content-card content-card-wide">
            <div class="card-header">
                <h2 class="card-title">My Requests</h2>
                <button class="link-primary" onclick="openHistoryModal()">View All ‚Üí</button>
            </div>
            <div class="card-body">
                {% if recent_requests %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Medicine Name</th>
                            <th>Quantity</th>
                            <th>Urgency</th>
                            <th>Status</th>
                            <th>Requested</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in recent_requests %}
                        <tr>
                            <td class="td-bold">{{ request.medicine_name }}</td>
                            <td>{{ request.quantity }}</td>
                            <td>
                                <span class="badge badge-{{ request.urgency }}">
                                    {{ request.get_urgency_display }}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-{{ request.status }}">
                                    {{ request.get_status_display }}
                                </span>
                            </td>
                            <td>{{ request.created_at|date:"M d, Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <p class="empty-text">No requests yet</p>
                    <p class="empty-subtext">Start by creating your first request</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recently Donated Medicines -->
        <div class="content-card">
            <div class="card-header">
                <h2 class="card-title">Recently Donated Medicines</h2>
            </div>
            <div class="card-body">
                {% if available_medicines %}
                <div class="medicine-list">
                    {% for medicine in available_medicines %}
                    <div class="medicine-item" onclick="showMedicineDetails({{ medicine.id }})" style="cursor: pointer;">
                        <div class="medicine-info">
                            <div class="medicine-name">{{ medicine.name }}</div>
                            <div class="medicine-meta">
                                <span class="medicine-qty">Qty: {{ medicine.quantity }}</span>
                                <span class="medicine-exp">Exp: {{ medicine.expiry_date|date:"M d, Y" }}</span>
                            </div>
                        </div>
                        <button class="btn-secondary btn-sm" onclick="event.stopPropagation(); requestThisMedicine('{{ medicine.name }}', {{ medicine.id }})">Request</button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state-sm">
                    <p class="empty-text">No medicines available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Claimed Medicines -->
        <div class="content-card">
            <div class="card-header">
                <h2 class="card-title">Claimed Medicines</h2>
            </div>
            <div class="card-body">
                {% if claimed_medicines %}
                <div class="request-list">
                    {% for request in claimed_medicines %}
                    <div class="request-item" onclick="showRequestDetails({{ request.id }})" style="cursor: pointer;">
                        <div class="request-info">
                            <div class="request-name">{{ request.medicine_name }}</div>
                            <div class="request-meta">
                                <span class="badge badge-success">‚úì Claimed</span>
                                <span class="request-date">{{ request.created_at|date:"M d" }}</span>
                            </div>
                        </div>
                        <button class="btn-secondary btn-sm" onclick="event.stopPropagation(); showRequestDetails({{ request.id }})">View</button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state-sm">
                    <p class="empty-text">No claimed medicines yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- All Medicines Browse Modal -->
<div class="modal-overlay" id="allMedicinesModal">
  <div class="modal-container modal-wide">
    <div class="modal-header">
      <h2 class="modal-title">Browse Medicines to Request</h2>
      <button class="modal-close" onclick="closeAllMedicinesModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="modal-info-text">
        üí° <em>Click image to view details</em>
      </div>
      <div class="modal-search-bar">
        <input type="text" id="medicineSearch" class="form-input" placeholder="Search medicines..." autocomplete="off">
        <div id="autocomplete-suggestions" class="autocomplete-suggestions"></div>
      </div>
      
      <!-- Expiry Range Filter -->
      <div class="filter-section" style="margin: 1rem 0; display: flex; gap: 1rem; align-items: center;">
        <label style="font-weight: 600; color: #374151;">Filter by Expiry:</label>
        <select id="expiryFilter" class="form-input" style="max-width: 200px;" onchange="filterByExpiry()">
          <option value="all">All Medicines</option>
          <option value="7">Expires within 7 days</option>
          <option value="14">Expires within 14 days</option>
          <option value="30">Expires within 30 days</option>
          <option value="60">Expires within 60 days</option>
        </select>
      </div>
      
      <div class="medicines-grid" id="medicinesGrid">
        {% if available_medicines %}
          {% for medicine in available_medicines %}
          <div class="medicine-card" data-name="{{ medicine.name|lower }}" onclick="showMedicineDetails({{ medicine.id }})">
            {% if medicine.image %}
            <div class="medicine-image">
              <img src="{{ medicine.image.url }}" alt="{{ medicine.name }}">
            </div>
            {% endif %}
            <div class="medicine-details">
              <h3 class="medicine-title">{{ medicine.name }}</h3>
              <div class="medicine-info-row">
                <span class="medicine-label">Quantity:</span>
                <span class="medicine-value">{{ medicine.quantity }}</span>
              </div>
              <div class="medicine-info-row">
                <span class="medicine-label">Expires:</span>
                <span class="medicine-value">{{ medicine.expiry_date|date:"M d, Y" }}</span>
              </div>
              <div class="medicine-info-row">
                <span class="medicine-label">Status:</span>
                <span class="badge badge-{{ medicine.status }}">{{ medicine.get_status_display }}</span>
              </div>
              {% if medicine.days_until_expiry <= 10 %}
              <div class="medicine-expiry-alert">
                ‚ö†Ô∏è Expires in {{ medicine.days_until_expiry }} days
              </div>
              {% endif %}
              <button class="btn-primary btn-sm mt-2" onclick="event.stopPropagation(); requestThisMedicine('{{ medicine.name }}', {{ medicine.id }})">Request This</button>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <p class="empty-text">No medicines available at the moment</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Notification Overlay -->
<div id="notificationOverlay" class="notification-overlay">
  <div class="notification-content">
    <span class="notification-icon" id="notificationIcon"></span>
    <span class="notification-message" id="notificationMessage"></span>
  </div>
</div>

<!-- Request Medicine Modal -->
<div class="modal-overlay" id="requestModal">
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title">Request Medicine</h2>
      <button class="modal-close" onclick="closeRequestModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form id="requestForm" onsubmit="submitRequest(event)">
        {% csrf_token %}
        
        <input type="hidden" name="donation_id" id="donationIdInput">
        
        <div class="form-group">
          <label class="form-label">Medicine Name</label>
          <input type="text" name="medicine_name" class="form-input" placeholder="Enter medicine name" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Quantity</label>
            <input type="number" name="quantity" class="form-input" placeholder="0" min="1" required>
          </div>

          <div class="form-group">
            <label class="form-label">Urgency Level</label>
            <select name="urgency" class="form-input" required>
              <option value="">Select urgency</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Reason (Optional)</label>
          <textarea name="reason" class="form-input" rows="3" placeholder="Why do you need this medicine?"></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" onclick="closeRequestModal()">Cancel</button>
          <button type="submit" class="btn-submit">Submit Request</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Request History Modal -->
<div class="modal-overlay" id="historyModal">
  <div class="modal-container modal-wide">
    <div class="modal-header">
      <h2 class="modal-title">Request History</h2>
      <button class="modal-close" onclick="closeHistoryModal()">√ó</button>
    </div>
    <div class="modal-body">
      {% if recent_requests %}
      <div class="history-table-wrapper">
        <table class="history-table">
          <thead>
            <tr>
              <th>Medicine Name</th>
              <th>Quantity</th>
              <th>Urgency</th>
              <th>Status</th>
              <th>Requested On</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for request in recent_requests %}
            <tr>
              <td><strong>{{ request.medicine_name }}</strong></td>
              <td>{{ request.quantity }}</td>
              <td>
                <span class="urgency-badge urgency-{{ request.urgency }}">
                  {{ request.get_urgency_display }}
                </span>
              </td>
              <td>
                <span class="status-badge status-{{ request.status }}">
                  {{ request.get_status_display }}
                </span>
              </td>
              <td>{{ request.created_at|date:"M d, Y" }}</td>
              <td>
                <button class="btn-table-action" onclick="showRequestDetails({{ request.id }})">View</button>
                <button class="btn-table-danger" onclick="deleteRequest({{ request.id }})">Delete</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="history-empty">
        <p>No request history found</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Medicine Details Modal -->
<div class="modal-overlay" id="medicineDetailsModal">
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title" id="medicineDetailsTitle">Medicine Details</h2>
      <button class="modal-close" onclick="closeMedicineDetailsModal()">√ó</button>
    </div>
    <div class="modal-body" id="medicineDetailsBody">
      <div class="details-loading">Loading...</div>
    </div>
  </div>
</div>

<!-- Request Details Modal -->
<div class="modal-overlay" id="requestDetailsModal">
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title" id="requestDetailsTitle">Request Details</h2>
      <button class="modal-close" onclick="closeRequestDetailsModal()">√ó</button>
    </div>
    <div class="modal-body" id="requestDetailsBody">
      <div class="details-loading">Loading...</div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteConfirmModal">
  <div class="modal-container modal-small">
    <div class="modal-header">
      <h2 class="modal-title">Confirm Delete</h2>
      <button class="modal-close" onclick="closeDeleteConfirmModal()">√ó</button>
    </div>
    <div class="modal-body">
      <p class="confirm-message" id="deleteConfirmMessage">Are you sure you want to delete this request? This action cannot be undone.</p>
      <div class="modal-actions">
        <button class="btn-danger" id="confirmDeleteBtn">Delete</button>
        <button class="btn-cancel" onclick="closeDeleteConfirmModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
// Notification System
function showNotification(message, type = 'success') {
  const overlay = document.getElementById('notificationOverlay');
  const icon = document.getElementById('notificationIcon');
  const messageEl = document.getElementById('notificationMessage');
  const content = overlay.querySelector('.notification-content');
  
  // Set icon based on type
  icon.textContent = type === 'success' ? '‚úÖ' : '‚ùå';
  messageEl.textContent = message;
  
  // Set style based on type
  content.className = 'notification-content ' + type;
  
  // Show notification
  overlay.classList.add('show');
  
  // Auto hide after 4 seconds
  setTimeout(() => {
    overlay.classList.remove('show');
  }, 4000);
}

// Medicine data for client-side operations
const allMedicines = [
  {% for medicine in all_available_medicines %}
  {
    id: {{ medicine.id }},
    name: "{{ medicine.name|escapejs }}",
    quantity: {{ medicine.quantity }},
    expiry_date: "{{ medicine.expiry_date|date:'M d, Y' }}",
    days_until_expiry: {{ medicine.days_until_expiry|default:999 }},
    status: "{{ medicine.status }}",
    status_display: "{{ medicine.get_status_display }}",
    {% if medicine.image %}image: "{{ medicine.image.url }}",{% endif %}
    donor_name: "{{ medicine.donor.first_name }} {{ medicine.donor.last_name }}",
    tracking_code: "{{ medicine.tracking_code }}",
    donated_at: "{{ medicine.donated_at|date:'M d, Y' }}"
  },
  {% endfor %}
];

// Request data (recent + claimed)
const requestData = [
  {% for request in recent_requests %}
  {
    id: {{ request.id }},
    medicine_name: "{{ request.medicine_name|escapejs }}",
    quantity: {{ request.quantity }},
    urgency: "{{ request.urgency }}",
    urgency_display: "{{ request.get_urgency_display }}",
    status: "{{ request.status }}",
    status_display: "{{ request.get_status_display }}",
    created_at: "{{ request.created_at|date:'M d, Y' }}",
    reason: "{{ request.reason|escapejs }}",
    tracking_code: "{{ request.tracking_code }}"
  },
  {% endfor %}
  {% for request in claimed_medicines %}
  {
    id: {{ request.id }},
    medicine_name: "{{ request.medicine_name|escapejs }}",
    quantity: {{ request.quantity }},
    urgency: "{{ request.urgency }}",
    urgency_display: "{{ request.get_urgency_display }}",
    status: "{{ request.status }}",
    status_display: "{{ request.get_status_display }}",
    created_at: "{{ request.created_at|date:'M d, Y' }}",
    reason: "{{ request.reason|escapejs }}",
    tracking_code: "{{ request.tracking_code }}"
  },
  {% endfor %}
];

function openAllMedicinesModal() {
  document.getElementById('allMedicinesModal').classList.add('active');
  renderMedicines(allMedicines);
}

function closeAllMedicinesModal() {
  document.getElementById('allMedicinesModal').classList.remove('active');
}

function openRequestModal() {
  document.getElementById('requestModal').classList.add('active');
  // Clear readonly state if it was set from requestThisMedicine
  const nameInput = document.querySelector('input[name="medicine_name"]');
  if (nameInput && !nameInput.value) {
    nameInput.removeAttribute('readonly');
    nameInput.style.backgroundColor = '';
    nameInput.style.cursor = '';
  }
}

function closeRequestModal() {
  document.getElementById('requestModal').classList.remove('active');
  // Reset the form when closing
  const nameInput = document.querySelector('input[name="medicine_name"]');
  if (nameInput) {
    nameInput.removeAttribute('readonly');
    nameInput.style.backgroundColor = '';
    nameInput.style.cursor = '';
  }
}

function openHistoryModal() {
  document.getElementById('historyModal').classList.add('active');
}

function closeHistoryModal() {
  document.getElementById('historyModal').classList.remove('active');
}

function openMedicineDetailsModal() {
  document.getElementById('medicineDetailsModal').classList.add('active');
}

function closeMedicineDetailsModal() {
  document.getElementById('medicineDetailsModal').classList.remove('active');
}

function openRequestDetailsModal() {
  document.getElementById('requestDetailsModal').classList.add('active');
}

function closeRequestDetailsModal() {
  document.getElementById('requestDetailsModal').classList.remove('active');
}

function showRequestDetails(requestId) {
  const request = requestData.find(r => r.id === requestId);
  if (!request) return;
  
  const title = document.getElementById('requestDetailsTitle');
  const body = document.getElementById('requestDetailsBody');
  
  title.textContent = `Request for ${request.medicine_name}`;
  
  body.innerHTML = `
    <div class="medicine-details-content">
      <div class="details-info">
        <div class="details-row">
          <span class="details-label">Medicine Name:</span>
          <span class="details-value"><strong>${request.medicine_name}</strong></span>
        </div>
        <div class="details-row">
          <span class="details-label">Quantity Requested:</span>
          <span class="details-value">${request.quantity}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Urgency:</span>
          <span class="badge badge-${request.urgency}">${request.urgency_display}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Status:</span>
          <span class="badge badge-${request.status}">${request.status_display}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Request Date:</span>
          <span class="details-value">${request.created_at}</span>
        </div>
        ${request.tracking_code ? `
          <div class="details-row">
            <span class="details-label">Tracking Code:</span>
            <span class="details-value"><code>${request.tracking_code}</code></span>
          </div>
        ` : ''}
        ${request.reason ? `
          <div class="details-row" style="flex-direction: column; align-items: flex-start;">
            <span class="details-label">Reason:</span>
            <span class="details-value" style="margin-top: 0.5rem;">${request.reason}</span>
          </div>
        ` : ''}
        ${request.status === 'fulfilled' ? `
          <div class="alert-success" style="margin-top: 1rem; padding: 1rem; background: #d1fae5; border-left: 3px solid #10b981; border-radius: 8px;">
            <strong>‚úÖ Ready to Claim!</strong>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Your medicine is ready for pickup. Click the button below to mark it as claimed.</p>
          </div>
        ` : ''}
        ${request.status === 'claimed' ? `
          <div class="alert-success" style="margin-top: 1rem; padding: 1rem; background: #e0e7ff; border-left: 3px solid #6366f1; border-radius: 8px;">
            <strong>‚úÖ Medicine Claimed!</strong>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">You have successfully claimed this medicine.</p>
          </div>
        ` : ''}
      </div>
      <div class="details-actions">
        ${request.status === 'fulfilled' ? `
          <button class="btn-primary" onclick="claimMedicine(${request.id})">
            <span style="margin-right: 0.5rem;">‚úÖ</span> Claim Medicine
          </button>
        ` : ''}
        ${request.status !== 'fulfilled' && request.status !== 'claimed' ? `
          <button class="btn-danger" onclick="deleteRequest(${request.id})">Delete Request</button>
        ` : ''}
        <button class="btn-cancel" onclick="closeRequestDetailsModal()">Close</button>
      </div>
    </div>
  `;
  
  openRequestDetailsModal();
}

function openDeleteConfirmModal() {
  document.getElementById('deleteConfirmModal').classList.add('active');
}

function closeDeleteConfirmModal() {
  document.getElementById('deleteConfirmModal').classList.remove('active');
}

function deleteRequest(requestId) {
  // Show confirmation modal instead of browser alert
  openDeleteConfirmModal();
  
  // Set up the confirm button click handler
  document.getElementById('confirmDeleteBtn').onclick = function() {
    closeDeleteConfirmModal();
    
    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/requests/${requestId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeRequestDetailsModal();
        closeHistoryModal();
        showNotification('Request deleted successfully', 'success');
        setTimeout(() => window.location.reload(), 1500);
      } else {
        showNotification('Error deleting request: ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('An error occurred while deleting the request.', 'error');
    });
  };
}

function claimMedicine(requestId) {
  if (!confirm('Mark this medicine as claimed? This confirms you have received the medicine.')) {
    return;
  }
  
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/requests/${requestId}/claim/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('Medicine claimed successfully!', 'success');
      closeRequestDetailsModal();
      setTimeout(() => window.location.reload(), 1500);
    } else {
      showNotification('Error: ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('An error occurred. Please try again.', 'error');
  });
}

function showMedicineDetails(medicineId) {
  const medicine = allMedicines.find(m => m.id === medicineId);
  if (!medicine) return;
  
  const title = document.getElementById('medicineDetailsTitle');
  const body = document.getElementById('medicineDetailsBody');
  
  title.textContent = medicine.name;
  
  body.innerHTML = `
    <div class="medicine-details-content">
      ${medicine.image ? `
        <div class="details-image">
          <img src="${medicine.image}" alt="${medicine.name}">
        </div>
      ` : ''}
      <div class="details-info">
        <div class="details-row">
          <span class="details-label">Medicine Name:</span>
          <span class="details-value"><strong>${medicine.name}</strong></span>
        </div>
        <div class="details-row">
          <span class="details-label">Quantity Available:</span>
          <span class="details-value">${medicine.quantity}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Expiry Date:</span>
          <span class="details-value">${medicine.expiry_date}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Days Until Expiry:</span>
          <span class="details-value">${medicine.days_until_expiry} days</span>
        </div>
        <div class="details-row">
          <span class="details-label">Status:</span>
          <span class="badge badge-${medicine.status}">${medicine.status_display}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Donated By:</span>
          <span class="details-value">${medicine.donor_name}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Donated On:</span>
          <span class="details-value">${medicine.donated_at}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Tracking Code:</span>
          <span class="details-value"><code>${medicine.tracking_code}</code></span>
        </div>
      </div>
      <div class="details-actions">
        <button class="btn-primary" onclick="closeMedicineDetailsModal(); requestThisMedicine('${medicine.name}', ${medicine.id})">Request This Medicine</button>
        <button class="btn-cancel" onclick="closeMedicineDetailsModal()">Close</button>
      </div>
    </div>
  `;
  
  openMedicineDetailsModal();
}

function requestThisMedicine(medicineName, donationId) {
  closeAllMedicinesModal();
  openRequestModal();
  // Pre-fill the medicine name and make it readonly
  const nameInput = document.querySelector('input[name="medicine_name"]');
  const donationInput = document.getElementById('donationIdInput');
  
  if (nameInput) {
    nameInput.value = medicineName;
    nameInput.setAttribute('readonly', 'readonly');
    nameInput.style.backgroundColor = '#f3f4f6';
    nameInput.style.cursor = 'not-allowed';
  }
  
  if (donationInput && donationId) {
    donationInput.value = donationId;
  }
}

function renderMedicines(medicines) {
  const grid = document.getElementById('medicinesGrid');
  if (medicines.length === 0) {
    grid.innerHTML = '<div class="empty-state"><p class="empty-text">No medicines available at the moment</p></div>';
    return;
  }
  
  grid.innerHTML = medicines.map(medicine => `
    <div class="medicine-card" data-name="${medicine.name.toLowerCase()}" onclick="showMedicineDetails(${medicine.id})" style="cursor: pointer;">
      ${medicine.image ? `
        <div class="medicine-image">
          <img src="${medicine.image}" alt="${medicine.name}">
        </div>
      ` : ''}
      <div class="medicine-details">
        <h3 class="medicine-title">${medicine.name}</h3>
        <div class="medicine-info-row">
          <span class="medicine-label">Quantity:</span>
          <span class="medicine-value">${medicine.quantity}</span>
        </div>
        <div class="medicine-info-row">
          <span class="medicine-label">Expires:</span>
          <span class="medicine-value">${medicine.expiry_date}</span>
        </div>
        <div class="medicine-info-row">
          <span class="medicine-label">Status:</span>
          <span class="badge badge-${medicine.status}">${medicine.status_display}</span>
        </div>
        ${medicine.days_until_expiry <= 10 ? `
          <div class="medicine-expiry-alert">
            ‚ö†Ô∏è Expires in ${medicine.days_until_expiry} days
          </div>
        ` : ''}
        <button class="btn-primary btn-sm mt-2" onclick="event.stopPropagation(); requestThisMedicine('${medicine.name}', ${medicine.id})">Request This</button>
      </div>
    </div>
  `).join('');
}

// Autocomplete for medicine search in browse modal
(function() {
  const input = document.getElementById('medicineSearch');
  if (!input) return;
  
  const container = document.getElementById('autocomplete-suggestions');
  let debounceTimer = null;
  let selectedIndex = -1;

  function showSuggestions(query) {
    if (!query || query.length < 2) {
      container.classList.remove('show');
      return;
    }

    const filtered = allMedicines.filter(m => 
      m.name.toLowerCase().includes(query.toLowerCase())
    );

    if (filtered.length === 0) {
      container.innerHTML = '<div class="autocomplete-empty">No medicines found</div>';
      container.classList.add('show');
      return;
    }

    const html = filtered.slice(0, 5).map((medicine, index) => {
      const regex = new RegExp(`(${query})`, 'gi');
      const highlighted = medicine.name.replace(regex, '<strong>$1</strong>');
      return `
        <div class="autocomplete-item" data-index="${index}" data-value="${medicine.name}">
          <span class="autocomplete-icon">üíä</span>
          <span>${highlighted}</span>
        </div>
      `;
    }).join('');

    container.innerHTML = html;
    container.classList.add('show');

    // Add click handlers
    container.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', () => {
        input.value = item.dataset.value;
        container.classList.remove('show');
        filterMedicinesByName(item.dataset.value);
      });
    });
  }

  // Input event
  input.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      showSuggestions(query);
      filterMedicinesByName(query);
    }, 300);
  });

  // Close on outside click
  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !container.contains(e.target)) {
      container.classList.remove('show');
    }
  });
})();

function filterMedicinesByName(query) {
  const expiryFilter = document.getElementById('expiryFilter').value;
  
  let filtered = allMedicines;
  
  // Apply search filter
  if (query) {
    filtered = filtered.filter(m => 
      m.name.toLowerCase().includes(query.toLowerCase())
    );
  }
  
  // Apply expiry filter
  if (expiryFilter !== 'all') {
    const days = parseInt(expiryFilter);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    filtered = filtered.filter(m => {
      const expiryDate = new Date(m.expiry_date);
      const diffTime = expiryDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays >= 0 && diffDays <= days;
    });
  }
  
  renderMedicines(filtered);
}

function filterByExpiry() {
  const expiryFilter = document.getElementById('expiryFilter').value;
  const searchQuery = document.getElementById('medicineSearch').value.trim();
  
  let filtered = allMedicines;
  
  // Apply search filter first
  if (searchQuery) {
    filtered = filtered.filter(m => 
      m.name.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }
  
  // Apply expiry filter
  if (expiryFilter !== 'all') {
    const days = parseInt(expiryFilter);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    filtered = filtered.filter(m => {
      const expiryDate = new Date(m.expiry_date);
      const diffTime = expiryDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays >= 0 && diffDays <= days;
    });
  }
  
  renderMedicines(filtered);
}

// Submit request via AJAX
function submitRequest(event) {
  event.preventDefault();
  
  const form = event.target;
  const formData = new FormData(form);
  const submitBtn = form.querySelector('button[type="submit"]');
  
  // Disable submit button
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  
  fetch('{% url "requests:create_request" %}', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Show success message
      showNotification('Request submitted successfully! Tracking Code: ' + data.tracking_code, 'success');
      
      // Close modal and reset form
      closeRequestModal();
      form.reset();
      
      // Reload page to show updated requests
      setTimeout(() => window.location.reload(), 1500);
    } else {
      showNotification('Error: ' + data.message, 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Request';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('An error occurred. Please try again.', 'error');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Request';
  });
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(modal => {
  modal.addEventListener('click', function(e) {
    if (e.target === this) {
      this.classList.remove('active');
    }
  });
});
</script>

{% endblock %}
