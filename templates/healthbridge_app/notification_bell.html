<!-- Notification Bell Dropdown Component -->
<style>
.notification-bell {
    position: relative;
    cursor: pointer;
    font-size: 1.5rem;
    color: #4b5563;
    transition: color 0.3s ease;
}

.notification-bell:hover {
    color: #1e3a8a;
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -8px;
    background-color: #ef4444;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.notification-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 10px;
    width: 400px;
    max-height: 500px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    z-index: 1000;
    display: none;
}

.notification-dropdown.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.notification-header {
    padding: 16px 20px;
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.notification-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.mark-all-read-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.3s ease;
}

.mark-all-read-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.notification-list {
    max-height: 400px;
    overflow-y: auto;
}

.notification-item {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
    transition: background 0.2s ease;
    position: relative;
}

.notification-item:hover {
    background: #f9fafb;
}

.notification-item.unread {
    background: #eff6ff;
}

.notification-item.unread::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #3b82f6;
}

.notification-icon {
    display: inline-block;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 1rem;
    flex-shrink: 0;
}

.notification-icon.approved {
    background: #dcfce7;
    color: #16a34a;
}

.notification-icon.rejected {
    background: #fee2e2;
    color: #dc2626;
}

.notification-content {
    display: flex;
    align-items: start;
}

.notification-text {
    flex: 1;
}

.notification-title {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
    font-size: 0.95rem;
}

.notification-message {
    color: #6b7280;
    font-size: 0.875rem;
    line-height: 1.4;
    margin-bottom: 4px;
}

.notification-time {
    color: #9ca3af;
    font-size: 0.75rem;
}

.notification-empty {
    padding: 40px 20px;
    text-align: center;
    color: #9ca3af;
}

.notification-empty i {
    font-size: 3rem;
    margin-bottom: 12px;
    opacity: 0.5;
}

.notification-footer {
    padding: 12px 20px;
    background: #f9fafb;
    text-align: center;
    border-top: 1px solid #e5e7eb;
}

.view-all-link {
    color: #1e3a8a;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 600;
    transition: color 0.3s ease;
}

.view-all-link:hover {
    color: #3b82f6;
}

/* Scrollbar styling */
.notification-list::-webkit-scrollbar {
    width: 6px;
}

.notification-list::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.notification-list::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.notification-list::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>

<div class="notification-container" style="position: relative;">
    <div class="notification-bell" id="notificationBell">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
    </div>
    
    <div class="notification-dropdown" id="notificationDropdown">
        <div class="notification-header">
            <h3>Notifications</h3>
            <button class="mark-all-read-btn" id="markAllReadBtn" style="display: none;">
                Mark all as read
            </button>
        </div>
        
        <div class="notification-list" id="notificationList">
            <div class="notification-empty">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications yet</p>
            </div>
        </div>
        
        <div class="notification-footer">
            <a href="{% url 'notifications_page' %}" class="view-all-link">
                View All Notifications
            </a>
        </div>
    </div>
</div>

<script>
// Notification System JavaScript
const notificationBell = document.getElementById('notificationBell');
const notificationDropdown = document.getElementById('notificationDropdown');
const notificationBadge = document.getElementById('notificationBadge');
const notificationList = document.getElementById('notificationList');
const markAllReadBtn = document.getElementById('markAllReadBtn');

// Toggle dropdown
notificationBell.addEventListener('click', (e) => {
    e.stopPropagation();
    notificationDropdown.classList.toggle('show');
    
    if (notificationDropdown.classList.contains('show')) {
        loadNotifications();
    }
});

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    if (!notificationDropdown.contains(e.target) && !notificationBell.contains(e.target)) {
        notificationDropdown.classList.remove('show');
    }
});

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Fetch unread count
async function updateUnreadCount() {
    try {
        const response = await fetch('/api/notifications/unread-count/');
        const data = await response.json();
        
        if (data.success && data.count > 0) {
            notificationBadge.textContent = data.count > 99 ? '99+' : data.count;
            notificationBadge.style.display = 'flex';
            markAllReadBtn.style.display = 'block';
        } else {
            notificationBadge.style.display = 'none';
            markAllReadBtn.style.display = 'none';
        }
    } catch (error) {
        console.error('Error fetching unread count:', error);
    }
}

// Load notifications
async function loadNotifications() {
    try {
        const response = await fetch('/api/notifications/');
        const data = await response.json();
        
        if (data.success && data.notifications.length > 0) {
            renderNotifications(data.notifications);
        } else {
            notificationList.innerHTML = `
                <div class="notification-empty">
                    <i class="fas fa-bell-slash"></i>
                    <p>No notifications yet</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
        notificationList.innerHTML = `
            <div class="notification-empty">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Failed to load notifications</p>
            </div>
        `;
    }
}

// Render notifications
function renderNotifications(notifications) {
    const notificationsHTML = notifications.map(notif => {
        const isApproved = notif.type.includes('APPROVED');
        const iconClass = isApproved ? 'approved' : 'rejected';
        const icon = isApproved ? '✅' : '❌';
        const unreadClass = notif.is_read ? '' : 'unread';
        
        return `
            <div class="notification-item ${unreadClass}" data-id="${notif.id}" onclick="markAsRead(${notif.id})">
                <div class="notification-content">
                    <div class="notification-icon ${iconClass}">
                        ${icon}
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">${notif.title}</div>
                        <div class="notification-message">${notif.message}</div>
                        <div class="notification-time">${notif.time_ago}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    notificationList.innerHTML = notificationsHTML;
}

// Mark notification as read
async function markAsRead(notificationId) {
    try {
        const response = await fetch(`/api/notifications/${notificationId}/read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update UI
            const notifElement = document.querySelector(`[data-id="${notificationId}"]`);
            if (notifElement) {
                notifElement.classList.remove('unread');
            }
            
            // Update badge count
            updateUnreadCount();
        }
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

// Mark all as read
markAllReadBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    
    try {
        const response = await fetch('/api/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update all notification items
            document.querySelectorAll('.notification-item').forEach(item => {
                item.classList.remove('unread');
            });
            
            // Update badge
            updateUnreadCount();
            markAllReadBtn.style.display = 'none';
        }
    } catch (error) {
        console.error('Error marking all as read:', error);
    }
});

// Update unread count on page load and every 30 seconds
updateUnreadCount();
setInterval(updateUnreadCount, 30000);
</script>
