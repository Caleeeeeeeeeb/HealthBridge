# HealthBridge Deployment Checklist

## ‚úÖ What's Already Configured

Your project is well-configured for deployment! Here's what's ready:

### 1. Build Configuration ‚úÖ
- `render-build.sh` - Build script with proper permissions
- `render.yaml` - Complete service configuration with:
  - Web service (main Django app)
  - Daily expiry check cron (8 AM daily)
  - Critical expiry check cron (every 6 hours)
- `Procfile` - Gunicorn configuration
- `requirements.txt` - All dependencies listed

### 2. Automated Expiry Notifications ‚úÖ
Your system will automatically:
- Check for medicines expiring within 10 days (daily at 8 AM)
- Check for critical medicines expiring in ‚â§3 days (every 6 hours)
- Send email alerts to donors and admins
- Prevent duplicate notifications
- Use batch email sending for efficiency

### 3. Email Configuration ‚úÖ
- Gmail SMTP configured
- Email templates with urgency levels
- Batch email support for performance

## üöÄ Deployment Steps

### Step 1: Set Environment Variables on Render

Go to Render Dashboard ‚Üí Your Service ‚Üí Environment and add these:

**Required Variables (must set manually):**
```
DATABASE_URL=postgresql://postgres.rovbuexxvufsylkahhgw:HealthBridge@aws-1-us-east-2.pooler.supabase.com:5432/postgres
EMAIL_HOST_USER=healthbridge.expiryalerts123@gmail.com
EMAIL_HOST_PASSWORD=qztedxatoprfxcoh
SUPABASE_URL=https://rovbuexxvufsylkahhgw.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvdmJ1ZXh4dnVmc3lsa2FoaGd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMDUzMzMsImV4cCI6MjA3NTg4MTMzM30.luwwQN1y7ltI-tGaoI00emKMlsfX_CZuAPlxE9M8MjQ
```

**Auto-configured Variables (in render.yaml):**
- `DJANGO_SECRET_KEY` - Auto-generated by Render
- `DEBUG` - Set to False
- `ALLOWED_HOSTS` - Set to healthbridge.onrender.com
- `EMAIL_HOST` - smtp.gmail.com
- `EMAIL_PORT` - 587
- `SUPABASE_BUCKET_NAME` - medicine-images
- `PYTHON_VERSION` - 3.13.3
- `DJANGO_SETTINGS_MODULE` - HealthBridge.settings

### Step 2: Deploy to Render

**Option A: Deploy from Dashboard (Easier)**
1. Go to https://dashboard.render.com
2. Click "New" ‚Üí "Blueprint"
3. Connect your GitHub repo (rcini19/HealthBridgeForked)
4. Render will read `render.yaml` automatically
5. Click "Apply" to create all services

**Option B: Deploy from Git Push**
1. Commit and push your changes:
   ```powershell
   git add .
   git commit -m "Configure deployment with automated expiry checks"
   git push origin main
   ```
2. Render will auto-deploy if connected to your repo

### Step 3: Verify Deployment

After deployment, check:

1. **Web Service is Running**
   - Visit: https://healthbridge.onrender.com
   - Should see your landing page

2. **Database Migrations Ran**
   - Check Render logs for: "Applying migrations..."
   - Should see: "No migrations to apply" or successful migration messages

3. **Static Files Collected**
   - Check logs for: "X static files copied"
   - CSS/JS should load on your site

4. **Cron Jobs Created**
   - In Render dashboard, you should see 3 services:
     - `healthbridge` (web)
     - `expiry-check-daily` (cron)
     - `expiry-check-critical` (cron)

### Step 4: Test Expiry Notifications

**Manual Test (from Render Shell):**
1. Go to your web service ‚Üí Shell tab
2. Run test command:
   ```bash
   python manage.py check_expiry --dry-run
   ```
3. Should see: "Would have sent X notifications"

**Live Test:**
1. Add a test medicine with expiry date within 10 days
2. Wait for next scheduled run or manually trigger:
   ```bash
   python manage.py check_expiry --days 10
   ```
3. Check email (donor + admins should receive notification)

## üìÖ Cron Schedule Explained

### Daily Check (8 AM)
- **Schedule:** `0 8 * * *` (8:00 AM daily, UTC time)
- **Command:** `python manage.py check_expiry --days 10`
- **Purpose:** Check all medicines expiring within 10 days
- **Recipients:** Donors + Admin staff

### Critical Check (Every 6 Hours)
- **Schedule:** `0 */6 * * *` (Every 6 hours)
- **Command:** `python manage.py check_expiry --critical-only`
- **Purpose:** Check medicines expiring ‚â§3 days (critical)
- **Recipients:** Donors + Admin staff

**Time Zones:**
- Render uses UTC by default
- 8 AM UTC = different times in your timezone
- Adjust schedule in `render.yaml` if needed

## üîß Troubleshooting

### Emails Not Sending

1. **Check Gmail App Password:**
   - Go to: https://myaccount.google.com/apppasswords
   - Generate new app password if needed
   - Update `EMAIL_HOST_PASSWORD` on Render

2. **Check Gmail Settings:**
   - 2FA must be enabled
   - "Less secure app access" should be OFF (use app password)

3. **Check Logs:**
   ```bash
   # In Render shell
   python manage.py check_expiry --days 10
   ```
   Look for email errors in output

### Cron Jobs Not Running

1. **Check Cron Service Status:**
   - Render Dashboard ‚Üí Cron Service
   - Should show "Live" status
   - Check "Logs" tab for execution history

2. **Verify Environment Variables:**
   - All cron jobs need database and email vars
   - Use `sync: false` to share vars across services

3. **Test Manually:**
   ```bash
   # In web service shell
   python manage.py check_expiry --dry-run
   ```

### Database Connection Issues

1. **Verify DATABASE_URL:**
   - Must be PostgreSQL connection string
   - Format: `postgresql://user:password@host:port/database`
   - Get from Supabase dashboard

2. **Check SSL Requirements:**
   - settings.py has `ssl_require=True`
   - Supabase requires SSL connections

## üìä Monitoring

### Check Expiry Alert History

```python
# In Django shell (Render)
python manage.py shell

from donations.models import ExpiryAlert
ExpiryAlert.objects.all().order_by('-sent_at')[:10]
```

### View Recent Donations Expiring

```python
from donations.models import Donation
from datetime import date, timedelta

expiring = Donation.objects.expiring_within(days=10)
for d in expiring:
    print(f"{d.name} - {d.expiry_date} ({d.days_until_expiry} days)")
```

## üéØ Next Steps After Deployment

1. ‚úÖ Test login with existing accounts
2. ‚úÖ Create test donation with near expiry
3. ‚úÖ Verify email notifications work
4. ‚úÖ Check cron logs after scheduled runs
5. ‚úÖ Monitor error logs in Render dashboard

## üìù Important Notes

- **Local `realtime_monitor.py`** - Only for local development
- **Render uses cron jobs** - No need for background workers
- **Environment variables** - Shared across services via `sync: false`
- **Emails** - Use Gmail app passwords, not regular password
- **Database** - Using Supabase PostgreSQL (not local SQLite)

## üîó Useful Links

- Render Dashboard: https://dashboard.render.com
- Your Site: https://healthbridge.onrender.com
- Supabase: https://rovbuexxvufsylkahhgw.supabase.co
- Gmail App Passwords: https://myaccount.google.com/apppasswords

---

Need help? Check Render logs first:
1. Dashboard ‚Üí Your Service ‚Üí Logs
2. Look for error messages
3. Search for "check_expiry" to see cron execution
